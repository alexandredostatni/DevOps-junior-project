# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: CI/CD DevOps Júnior

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instalar dependências
        run: |
          pip install --upgrade pip
          pip install -r app/requirements.txt

      - name: Testar API (simulado)
        run: |
          pip install requests
          cat << 'PYTEST' > test_api.py
import requests
import time
import subprocess
import sys

print("Iniciando docker-compose...")
subprocess.Popen(['docker', 'compose', 'up', '-d'])
time.sleep(20)

try:
    print("Testando POST /usuario...")
    r = requests.post(
        'http://localhost:5000/usuario',
        json={'nome': 'Teste CI', 'email': 'ci@test.com'},
        timeout=15
    )
    if r.status_code == 201:
        print("API OK! Status 201")
    else:
        print(f"Falha: {r.status_code} - {r.text}")
        sys.exit(1)
except Exception as e:
    print(f"Erro na requisição: {e}")
    sys.exit(1)
finally:
    print("Parando docker-compose...")
    subprocess.run(['docker', 'compose', 'down'], cwd='.')
PYTEST
          python test_api.py

      - name: Build Docker Image
        run: docker build -t api-devops:latest ./app

      - name: Zip app para S3
        run: |
          zip -r app.zip app/
          mkdir -p infra/terraform
          cp app.zip infra/terraform/

      - name: Iniciar LocalStack
        run: |
          docker run -d -p 4566:4566 -p 4571:4571 --name localstack localstack/localstack
          sleep 35

      - name: Aplicar Terraform
        run: |
          cd infra/terraform
          terraform init
          terraform apply -auto-approve

      - name: Load imagem no kind
        run: kind load docker-image api-devops:latest

      - name: Deploy no Kubernetes
        run: |
          kubectl apply -f kubernetes/mongo/
          kubectl apply -f kubernetes/deployment.yaml
          kubectl apply -f kubernetes/service.yaml

      - name: Aguardar rollout
        run: kubectl rollout status deployment/api-devops --timeout=120s

      - name: Teste final no K8s
        run: |
          sleep 15
          curl -f http://localhost:5000/ || exit 1
