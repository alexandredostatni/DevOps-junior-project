# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: CI/CD DevOps Júnior

 on:
   push:
     branches: [ main ]
   pull_request:
     branches: [ main ]

 jobs:
   build-and-deploy:
     runs-on: ubuntu-latest

     steps:
       - name: Checkout código
         uses: actions/checkout@v4

       - name: Configurar Python
         uses: actions/setup-python@v4
         with:
           python-version: '3.11'

       - name: Instalar dependências
         run: |
           pip install --upgrade pip
           pip install -r app/requirements.txt

       - name: Testar API (simulado)
         run: |
           pip install requests
           cat > test_api.py << 'EOF'
import requests
import time
import subprocess
import sys

# Inicia docker-compose em background
subprocess.Popen(['docker', 'compose', 'up', '-d'])
time.sleep(15)

# Testa a API
try:
    r = requests.post(
        'http://localhost:5000/usuario',
        json={'nome': 'Teste', 'email': 'ci@test.com'},
        timeout=10
    )
    if r.status_code == 201:
        print("Teste da API: SUCESSO")
    else:
        print(f"Erro: {r.status_code}")
        sys.exit(1)
except Exception as e:
    print(f"Falha no teste: {e}")
    sys.exit(1)
finally:
    subprocess.run(['docker', 'compose', 'down'])
EOF
           python test_api.py

       - name: Build Docker Image
         run: |
           docker build -t api-devops:latest ./app

       - name: Zip app para S3
         run: |
           zip -r app.zip app/
           mkdir -p infra/terraform
           cp app.zip infra/terraform/

       - name: Iniciar LocalStack
         run: |
           docker run -d -p 4566:4566 -p 4571:4571 localstack/localstack
           sleep 30

       - name: Aplicar Terraform
         run: |
           cd infra/terraform
           terraform init
           terraform apply -auto-approve

       - name: Load imagem no kind
         run: |
           kind load docker-image api-devops:latest

       - name: Deploy no Kubernetes
         run: |
           kubectl apply -f kubernetes/mongo/
           kubectl apply -f kubernetes/deployment.yaml
           kubectl apply -f kubernetes/service.yaml

       - name: Aguardar rollout
         run: |
           kubectl rollout status deployment/api-devops

       - name: Teste final no K8s
         run: |
           sleep 10
           curl -f http://localhost:5000/ || exit 1
